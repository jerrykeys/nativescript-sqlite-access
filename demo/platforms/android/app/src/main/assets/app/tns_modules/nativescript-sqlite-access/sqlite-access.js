"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var app = require("tns-core-modules/application");
var SqliteAccess = /** @class */ (function () {
    function SqliteAccess(db, options) {
        this._db = db;
        this._options = options;
    }
    SqliteAccess.prototype.insert = function (table, values) {
        return this._db.insert(table, null, __mapToContentValues(values));
    };
    SqliteAccess.prototype.replace = function (table, values) {
        return this._db.replace(table, null, __mapToContentValues(values));
    };
    SqliteAccess.prototype.update = function (table, values, whereClause, whereArs) {
        return this._db.update(table, __mapToContentValues(values), whereClause, __objectArrayToStringArray(whereArs));
    };
    SqliteAccess.prototype.delete = function (table, whereClause, whereArs) {
        return this._db.delete(table, whereClause, __objectArrayToStringArray(whereArs));
    };
    SqliteAccess.prototype.select = function (sql, params) {
        var me = this;
        return new Promise(function (resolve, error) {
            var cursor = me._db.rawQuery(sql, __objectArrayToStringArray(params));
            try {
                var toArrayOfObject = __processCursor(cursor);
                var result = toArrayOfObject(me._options.returnType);
                resolve(result);
            }
            catch (ex) {
                error(ex);
            }
        });
    };
    SqliteAccess.prototype.query = function (table, columns, selection, selectionArgs, groupBy, orderBy, limit) {
        var me = this;
        return new Promise(function (resolve, error) {
            var cursor = me._db.query(table, columns, selection, __objectArrayToStringArray(selectionArgs), groupBy, orderBy, limit);
            try {
                var toArrayOfObject = __processCursor(cursor);
                var result = toArrayOfObject(me._options.returnType);
                resolve(result);
            }
            catch (ex) {
                error(ex);
            }
        });
    };
    SqliteAccess.prototype.execSQL = function (sql) {
        this._db.execSQL(sql);
    };
    SqliteAccess.prototype.beginTransact = function () {
        this._db.beginTransaction();
    };
    SqliteAccess.prototype.commit = function () {
        this._db.setTransactionSuccessful();
        this._db.endTransaction();
    };
    SqliteAccess.prototype.rollback = function () {
        this._db.endTransaction();
    };
    SqliteAccess.prototype.close = function () {
        this._db.close();
        this._db = null;
    };
    return SqliteAccess;
}());
function __processCursor(cursor) {
    return function (returnType) {
        var result = [];
        if (cursor.getCount() > 0) {
            while (cursor.moveToNext()) {
                result.push(__getRowValues(cursor, cursor.getColumnCount(), returnType));
            }
        }
        cursor.close();
        return result;
    };
}
/**
 * Process the sqlite cursor and return a js object with column/value
 * @param cursor
 * @param columnCount
 * @returns JS object like {[column:string]: any}
 */
function __getRowValues(cursor, columnCount, returnType) {
    var rowValue = {};
    if (returnType === 1 /* AS_ARRAY */) {
        rowValue = [];
    }
    var primitiveType = null;
    var columnName = '';
    var value = null;
    for (var i = 0; i < columnCount; i++) {
        primitiveType = cursor.getType(i);
        columnName = cursor.getColumnName(i);
        switch (primitiveType) {
            case android.database.Cursor.FIELD_TYPE_INTEGER:
                value = cursor.getLong(i);
                break;
            case android.database.Cursor.FIELD_TYPE_FLOAT:
                value = cursor.getFloat(i);
                break;
            case android.database.Cursor.FIELD_TYPE_NULL:
                value = null;
                break;
            case android.database.Cursor.FIELD_TYPE_BLOB:
                value = cursor.getBlob(i);
                break;
            case android.database.Cursor.FIELD_TYPE_STRING:
                value = cursor.getString(i);
                break;
        }
        // If result is wanted as array of array
        if (Array.isArray(rowValue) && returnType === 1 /* AS_ARRAY */) {
            rowValue.push(value);
            continue;
        }
        rowValue[columnName] = value;
    }
    return rowValue;
}
function __openCreateDataBase(dbName, mode) {
    if (dbName === ":memory:") {
        return android.database.sqlite.SQLiteDatabase.create(null);
    }
    dbName = __getContext().getDatabasePath(dbName).getAbsolutePath().toString();
    mode = mode | android.database.sqlite.SQLiteDatabase.CREATE_IF_NECESSARY;
    return android.database.sqlite.SQLiteDatabase.openDatabase(dbName, null, mode);
}
function __objectArrayToStringArray(params) {
    if (!params)
        return null;
    var stringArray = [];
    for (var key in params) {
        stringArray.push(params[key] && params[key].toString() || null);
    }
    return stringArray;
}
function __mapToContentValues(values) {
    var contentValues = new android.content.ContentValues();
    for (var key in values) {
        if (values.hasOwnProperty(key)
            && values[key] !== null && values[key] !== undefined) {
            contentValues.put(key, values[key]);
        }
        else {
            contentValues.putNull(key);
        }
    }
    return contentValues;
}
function __getContext() {
    return (app.android.context
        || (app.getNativeApplication && app.getNativeApplication()));
}
function DbBuilder(dbName, options) {
    if (!dbName)
        throw "Must specify a db name";
    console.dir(options);
    options = options || {
        version: 1
    };
    // Ensure version be 1 or greater and returnType AS_OBJECT
    options.version = options.version || 1;
    options.returnType = options.returnType || 0 /* AS_OBJECT */;
    var db = __openCreateDataBase(dbName, android.database.sqlite.SQLiteDatabase.OPEN_READWRITE);
    var curVersion = db.getVersion();
    console.log("db v: " + curVersion + ", " + options.version);
    if (options.version > curVersion) {
        db.setVersion(options.version);
        var tableCreateScripts = options.createTableScriptsFn && options.createTableScriptsFn();
        var tableDroptScripts = options.dropTableScriptsFn && options.dropTableScriptsFn();
        try {
            console.log("script", tableCreateScripts);
            // Dropping all tables
            if (tableDroptScripts) {
                for (var script in tableDroptScripts) {
                    db.execSQL(tableDroptScripts[script]);
                }
            }
            console.log("drop", tableDroptScripts);
            // Creating all tables
            if (tableCreateScripts) {
                for (var script in tableCreateScripts) {
                    db.execSQL(tableCreateScripts[script]);
                }
            }
        }
        catch (error) {
            db.setVersion(curVersion);
            db.close();
            throw error;
        }
    }
    else if (options.version < curVersion) {
        db.close();
        throw "It is not possible to set the version " + options.version + " to database, because is lower then current version, Db current version is " + curVersion;
    }
    return new SqliteAccess(db, options);
}
exports.DbBuilder = DbBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FsaXRlLWFjY2Vzcy5hbmRyb2lkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3FsaXRlLWFjY2Vzcy5hbmRyb2lkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esa0RBQW9EO0FBR3BEO0lBSUksc0JBQVksRUFBMEMsRUFDbEQsT0FBMEI7UUFDMUIsSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztJQUM1QixDQUFDO0lBRUQsNkJBQU0sR0FBTixVQUFPLEtBQWEsRUFBRSxNQUErQjtRQUNqRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsOEJBQU8sR0FBUCxVQUFRLEtBQWEsRUFBRSxNQUErQjtRQUNsRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsNkJBQU0sR0FBTixVQUFPLEtBQWEsRUFBRSxNQUErQixFQUFFLFdBQW1CLEVBQUUsUUFBZTtRQUN2RixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsRUFBRSxXQUFXLEVBQUUsMEJBQTBCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUNuSCxDQUFDO0lBRUQsNkJBQU0sR0FBTixVQUFPLEtBQWEsRUFBRSxXQUFtQixFQUFFLFFBQWU7UUFDdEQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLDBCQUEwQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDckYsQ0FBQztJQUVELDZCQUFNLEdBQU4sVUFBTyxH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RUFBRSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMxQixFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxNQUFNLEtBQUssQ0FBQztTQUNmO0tBRUo7U0FBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLEdBQUcsVUFBVSxFQUFFO1FBQ3JDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNYLE1BQU0sMkNBQXlDLE9BQU8sQ0FBQyxPQUFPLG1GQUE4RSxVQUFZLENBQUM7S0FDNUo7SUFDRCxPQUFPLElBQUksWUFBWSxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBN0NELDhCQTZDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElEYXRhYmFzZSB9IGZyb20gJy4vY29tbW9uL0lEYXRhYmFzZSc7XG5pbXBvcnQgKiBhcyBhcHAgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcbmltcG9ydCB7IERiQ3JlYXRpb25PcHRpb25zLCBSZXR1cm5UeXBlIH0gZnJvbSAnLi9jb21tb24vQ29tbW9uJztcblxuY2xhc3MgU3FsaXRlQWNjZXNzIGltcGxlbWVudHMgSURhdGFiYXNlIHtcbiAgICBcbiAgICBwcml2YXRlIF9kYjogYW5kcm9pZC5kYXRhYmFzZS5zcWxpdGUuU1FMaXRlRGF0YWJhc2U7XG4gICAgcHJpdmF0ZSBfb3B0aW9uczogRGJDcmVhdGlvbk9wdGlvbnM7XG4gICAgY29uc3RydWN0b3IoZGI6IGFuZHJvaWQuZGF0YWJhc2Uuc3FsaXRlLlNRTGl0ZURhdGFiYXNlLCBcbiAgICAgICAgb3B0aW9uczogRGJDcmVhdGlvbk9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5fZGIgPSBkYjtcbiAgICAgICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgfVxuXG4gICAgaW5zZXJ0KHRhYmxlOiBzdHJpbmcsIHZhbHVlczogeyBba2V5OiBzdHJpbmddOiBhbnk7IH0pOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGIuaW5zZXJ0KHRhYmxlLCBudWxsLCBfX21hcFRvQ29udGVudFZhbHVlcyh2YWx1ZXMpKTtcbiAgICB9ICAgIFxuICAgIFxuICAgIHJlcGxhY2UodGFibGU6IHN0cmluZywgdmFsdWVzOiB7IFtrZXk6IHN0cmluZ106IGFueTsgfSk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYi5yZXBsYWNlKHRhYmxlLCBudWxsLCBfX21hcFRvQ29udGVudFZhbHVlcyh2YWx1ZXMpKTtcbiAgICB9XG5cbiAgICB1cGRhdGUodGFibGU6IHN0cmluZywgdmFsdWVzOiB7IFtrZXk6IHN0cmluZ106IGFueTsgfSwgd2hlcmVDbGF1c2U6IHN0cmluZywgd2hlcmVBcnM6IGFueVtdKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RiLnVwZGF0ZSh0YWJsZSwgX19tYXBUb0NvbnRlbnRWYWx1ZXModmFsdWVzKSwgd2hlcmVDbGF1c2UsIF9fb2JqZWN0QXJyYXlUb1N0cmluZ0FycmF5KHdoZXJlQXJzKSk7XG4gICAgfVxuXG4gICAgZGVsZXRlKHRhYmxlOiBzdHJpbmcsIHdoZXJlQ2xhdXNlOiBzdHJpbmcsIHdoZXJlQXJzOiBhbnlbXSk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYi5kZWxldGUodGFibGUsIHdoZXJlQ2xhdXNlLCBfX29iamVjdEFycmF5VG9TdHJpbmdBcnJheSh3aGVyZUFycykpO1xuICAgIH1cblxuICAgIHNlbGVjdChzcWw6IHN0cmluZywgcGFyYW1zPzogYW55W10pOiBQcm9taXNlPEFycmF5PGFueT4+IHtcbiAgICAgICAgY29uc3QgbWUgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgZXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBjdXJzb3IgPSAgbWUuX2RiLnJhd1F1ZXJ5KHNxbCwgX19vYmplY3RBcnJheVRvU3RyaW5nQXJyYXkocGFyYW1zKSk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRvQXJyYXlPZk9iamVjdCA9IF9fcHJvY2Vzc0N1cnNvcihjdXJzb3IpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRvQXJyYXlPZk9iamVjdChtZS5fb3B0aW9ucy5yZXR1cm5UeXBlKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICB9IGNhdGNoKGV4KSB7XG4gICAgICAgICAgICAgICAgZXJyb3IoZXgpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHF1ZXJ5KHRhYmxlOiBzdHJpbmcsIGNvbHVtbnM/OiBzdHJpbmdbXSwgc2VsZWN0aW9uPzogc3RyaW5nLCBzZWxlY3Rpb25BcmdzPzogYW55W10sIGdyb3VwQnk/OiBzdHJpbmcsIG9yZGVyQnk/OiBzdHJpbmcsIGxpbWl0Pzogc3RyaW5nKTogUHJvbWlzZTxBcnJheTxhbnk+PiB7XG4gICAgICAgIGNvbnN0IG1lID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgY3Vyc29yID0gIG1lLl9kYi5xdWVyeSh0YWJsZSwgY29sdW1ucywgc2VsZWN0aW9uLCBfX29iamVjdEFycmF5VG9TdHJpbmdBcnJheShzZWxlY3Rpb25BcmdzKSwgZ3JvdXBCeSwgb3JkZXJCeSwgbGltaXQpO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0b0FycmF5T2ZPYmplY3QgPSBfX3Byb2Nlc3NDdXJzb3IoY3Vyc29yKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSB0b0FycmF5T2ZPYmplY3QobWUuX29wdGlvbnMucmV0dXJuVHlwZSk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgfSBjYXRjaChleCkge1xuICAgICAgICAgICAgICAgIGVycm9yKGV4KVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBleGVjU1FMKHNxbDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuX2RiLmV4ZWNTUUwoc3FsKTtcbiAgICB9XG5cbiAgICBiZWdpblRyYW5zYWN0KCkge1xuICAgICAgICB0aGlzLl9kYi5iZWdpblRyYW5zYWN0aW9uKCk7XG4gICAgfVxuXG4gICAgY29tbWl0KCkge1xuICAgICAgICB0aGlzLl9kYi5zZXRUcmFuc2FjdGlvblN1Y2Nlc3NmdWwoKTtcbiAgICAgICAgdGhpcy5fZGIuZW5kVHJhbnNhY3Rpb24oKTtcbiAgICB9XG5cbiAgICByb2xsYmFjaygpIHtcbiAgICAgICAgdGhpcy5fZGIuZW5kVHJhbnNhY3Rpb24oKTtcbiAgICB9XG5cbiAgICBjbG9zZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fZGIuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5fZGIgPSBudWxsO1xuICAgIH1cbn1cblxuXG5mdW5jdGlvbiBfX3Byb2Nlc3NDdXJzb3IoY3Vyc29yOiBhbmRyb2lkLmRhdGFiYXNlLkN1cnNvcikge1xuICAgIHJldHVybiAocmV0dXJuVHlwZTogUmV0dXJuVHlwZSkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcbiAgICAgICAgaWYgKGN1cnNvci5nZXRDb3VudCgpID4gMCkge1xuICAgICAgICAgICAgd2hpbGUgKCBjdXJzb3IubW92ZVRvTmV4dCgpICkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCBfX2dldFJvd1ZhbHVlcyhjdXJzb3IsIGN1cnNvci5nZXRDb2x1bW5Db3VudCgpLCByZXR1cm5UeXBlKSApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGN1cnNvci5jbG9zZSgpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbn1cblxuLyoqXG4gKiBQcm9jZXNzIHRoZSBzcWxpdGUgY3Vyc29yIGFuZCByZXR1cm4gYSBqcyBvYmplY3Qgd2l0aCBjb2x1bW4vdmFsdWVcbiAqIEBwYXJhbSBjdXJzb3IgXG4gKiBAcGFyYW0gY29sdW1uQ291bnQgXG4gKiBAcmV0dXJucyBKUyBvYmplY3QgbGlrZSB7W2NvbHVtbjpzdHJpbmddOiBhbnl9XG4gKi9cbmZ1bmN0aW9uIF9fZ2V0Um93VmFsdWVzKGN1cnNvcjogYW5kcm9pZC5kYXRhYmFzZS5DdXJzb3IsIGNvbHVtbkNvdW50Om51bWJlciwgXG4gICAgcmV0dXJuVHlwZTogUmV0dXJuVHlwZSk6IGFueSB7XG5cbiAgICBsZXQgcm93VmFsdWU6IGFueSA9IHt9O1xuICAgIGlmIChyZXR1cm5UeXBlID09PSBSZXR1cm5UeXBlLkFTX0FSUkFZKSB7XG4gICAgICAgIHJvd1ZhbHVlID0gW107XG4gICAgfVxuXG4gICAgbGV0IHByaW1pdGl2ZVR5cGUgPSBudWxsO1xuICAgIGxldCBjb2x1bW5OYW1lID0gJyc7XG4gICAgbGV0IHZhbHVlID0gbnVsbDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbHVtbkNvdW50OyBpKyspIHtcbiAgICAgICAgcHJpbWl0aXZlVHlwZSA9IGN1cnNvci5nZXRUeXBlKGkpO1xuICAgICAgICBjb2x1bW5OYW1lID0gY3Vyc29yLmdldENvbHVtbk5hbWUoaSk7XG4gICAgICAgIHN3aXRjaCAocHJpbWl0aXZlVHlwZSkge1xuICAgICAgICAgICAgY2FzZSBhbmRyb2lkLmRhdGFiYXNlLkN1cnNvci5GSUVMRF9UWVBFX0lOVEVHRVI6IFxuICAgICAgICAgICAgICAgIHZhbHVlID0gY3Vyc29yLmdldExvbmcoaSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGFuZHJvaWQuZGF0YWJhc2UuQ3Vyc29yLkZJRUxEX1RZUEVfRkxPQVQ6IFxuICAgICAgICAgICAgICAgIHZhbHVlID0gY3Vyc29yLmdldEZsb2F0KGkpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBhbmRyb2lkLmRhdGFiYXNlLkN1cnNvci5GSUVMRF9UWVBFX05VTEw6XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBudWxsO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBhbmRyb2lkLmRhdGFiYXNlLkN1cnNvci5GSUVMRF9UWVBFX0JMT0I6XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBjdXJzb3IuZ2V0QmxvYihpKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgYW5kcm9pZC5kYXRhYmFzZS5DdXJzb3IuRklFTERfVFlQRV9TVFJJTkc6IFxuICAgICAgICAgICAgICAgIHZhbHVlID0gY3Vyc29yLmdldFN0cmluZyhpKTsgICAgXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgLy8gSWYgcmVzdWx0IGlzIHdhbnRlZCBhcyBhcnJheSBvZiBhcnJheVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyb3dWYWx1ZSkgJiYgcmV0dXJuVHlwZSA9PT0gUmV0dXJuVHlwZS5BU19BUlJBWSkge1xuICAgICAgICAgICAgcm93VmFsdWUucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJvd1ZhbHVlW2NvbHVtbk5hbWVdID0gdmFsdWU7XG4gICAgfVxuICAgIHJldHVybiByb3dWYWx1ZTtcbn1cblxuXG5mdW5jdGlvbiBfX29wZW5DcmVhdGVEYXRhQmFzZShkYk5hbWU6IHN0cmluZywgbW9kZTogbnVtYmVyKSB7XG4gICAgaWYgKGRiTmFtZSA9PT0gXCI6bWVtb3J5OlwiKSB7XG4gICAgICAgIHJldHVybiBhbmRyb2lkLmRhdGFiYXNlLnNxbGl0ZS5TUUxpdGVEYXRhYmFzZS5jcmVhdGUobnVsbCk7XG4gICAgfVxuXG4gICAgZGJOYW1lID0gX19nZXRDb250ZXh0KCkuZ2V0RGF0YWJhc2VQYXRoKGRiTmFtZSkuZ2V0QWJzb2x1dGVQYXRoKCkudG9TdHJpbmcoKTtcbiAgICBtb2RlID0gIG1vZGUgfCBhbmRyb2lkLmRhdGFiYXNlLnNxbGl0ZS5TUUxpdGVEYXRhYmFzZS5DUkVBVEVfSUZfTkVDRVNTQVJZO1xuICAgIHJldHVybiBhbmRyb2lkLmRhdGFiYXNlLnNxbGl0ZS5TUUxpdGVEYXRhYmFzZS5vcGVuRGF0YWJhc2UoZGJOYW1lLCBudWxsLCBtb2RlKTtcbn1cblxuZnVuY3Rpb24gX19vYmplY3RBcnJheVRvU3RyaW5nQXJyYXkocGFyYW1zOiBBcnJheTxhbnk+KSB7XG4gICAgaWYgKCFwYXJhbXMpIHJldHVybiBudWxsO1xuXG4gICAgbGV0IHN0cmluZ0FycmF5OkFycmF5PHN0cmluZz4gPSBbXTtcbiAgICBmb3IobGV0IGtleSBpbiBwYXJhbXMpIHtcbiAgICAgICAgc3RyaW5nQXJyYXkucHVzaCggcGFyYW1zW2tleV0gJiYgcGFyYW1zW2tleV0udG9TdHJpbmcoKSB8fCBudWxsICk7XG4gICAgfVxuICAgIHJldHVybiBzdHJpbmdBcnJheTtcbn1cblxuZnVuY3Rpb24gX19tYXBUb0NvbnRlbnRWYWx1ZXModmFsdWVzOiB7IFtrZXk6IHN0cmluZ106IGFueTsgfSkge1xuICAgIGxldCBjb250ZW50VmFsdWVzID0gbmV3IGFuZHJvaWQuY29udGVudC5Db250ZW50VmFsdWVzKCk7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gdmFsdWVzKSB7XG4gICAgICAgIGlmICh2YWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSBcbiAgICAgICAgICAgICYmIHZhbHVlc1trZXldICE9PSBudWxsICYmIHZhbHVlc1trZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnRlbnRWYWx1ZXMucHV0KGtleSwgdmFsdWVzW2tleV0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udGVudFZhbHVlcy5wdXROdWxsKGtleSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNvbnRlbnRWYWx1ZXM7XG59XG5cbmZ1bmN0aW9uIF9fZ2V0Q29udGV4dCgpIHtcbiAgICByZXR1cm4gKGFwcC5hbmRyb2lkLmNvbnRleHQgXG4gICAgICAgICAgICB8fCAoYXBwLmdldE5hdGl2ZUFwcGxpY2F0aW9uICYmIGFwcC5nZXROYXRpdmVBcHBsaWNhdGlvbigpKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBEYkJ1aWxkZXIoZGJOYW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBEYkNyZWF0aW9uT3B0aW9ucykgOiBTcWxpdGVBY2Nlc3Mge1xuICAgIGlmICghZGJOYW1lKSB0aHJvdyBcIk11c3Qgc3BlY2lmeSBhIGRiIG5hbWVcIjtcblxuICAgIGNvbnNvbGUuZGlyKG9wdGlvbnMpO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHtcbiAgICAgICAgdmVyc2lvbjogMVxuICAgIH07XG4gICAgLy8gRW5zdXJlIHZlcnNpb24gYmUgMSBvciBncmVhdGVyIGFuZCByZXR1cm5UeXBlIEFTX09CSkVDVFxuICAgIG9wdGlvbnMudmVyc2lvbiA9IG9wdGlvbnMudmVyc2lvbiB8fCAxO1xuICAgIG9wdGlvbnMucmV0dXJuVHlwZSA9IG9wdGlvbnMucmV0dXJuVHlwZSB8fCBSZXR1cm5UeXBlLkFTX09CSkVDVDtcblxuICAgIGNvbnN0IGRiID0gX19vcGVuQ3JlYXRlRGF0YUJhc2UoZGJOYW1lLCBhbmRyb2lkLmRhdGFiYXNlLnNxbGl0ZS5TUUxpdGVEYXRhYmFzZS5PUEVOX1JFQURXUklURSk7XG4gICAgY29uc3QgY3VyVmVyc2lvbiA9IGRiLmdldFZlcnNpb24oKTtcbiAgICBjb25zb2xlLmxvZyhgZGIgdjogJHtjdXJWZXJzaW9ufSwgJHtvcHRpb25zLnZlcnNpb259YCk7XG4gICAgaWYgKG9wdGlvbnMudmVyc2lvbiA+IGN1clZlcnNpb24pIHtcbiAgICAgICAgZGIuc2V0VmVyc2lvbihvcHRpb25zLnZlcnNpb24pO1xuICAgICAgICBjb25zdCB0YWJsZUNyZWF0ZVNjcmlwdHMgPSBvcHRpb25zLmNyZWF0ZVRhYmxlU2NyaXB0c0ZuICYmIG9wdGlvbnMuY3JlYXRlVGFibGVTY3JpcHRzRm4oKTtcbiAgICAgICAgY29uc3QgdGFibGVEcm9wdFNjcmlwdHMgPSBvcHRpb25zLmRyb3BUYWJsZVNjcmlwdHNGbiAmJiBvcHRpb25zLmRyb3BUYWJsZVNjcmlwdHNGbigpO1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2NyaXB0XCIsIHRhYmxlQ3JlYXRlU2NyaXB0cyk7XG4gICAgICAgICAgICAvLyBEcm9wcGluZyBhbGwgdGFibGVzXG4gICAgICAgICAgICBpZiAodGFibGVEcm9wdFNjcmlwdHMpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBzY3JpcHQgaW4gdGFibGVEcm9wdFNjcmlwdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0YWJsZURyb3B0U2NyaXB0c1tzY3JpcHRdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImRyb3BcIiwgdGFibGVEcm9wdFNjcmlwdHMpO1xuICAgICAgICAgICAgLy8gQ3JlYXRpbmcgYWxsIHRhYmxlc1xuICAgICAgICAgICAgaWYgKHRhYmxlQ3JlYXRlU2NyaXB0cykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHNjcmlwdCBpbiB0YWJsZUNyZWF0ZVNjcmlwdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0YWJsZUNyZWF0ZVNjcmlwdHNbc2NyaXB0XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZGIuc2V0VmVyc2lvbihjdXJWZXJzaW9uKTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgfSBlbHNlIGlmIChvcHRpb25zLnZlcnNpb24gPCBjdXJWZXJzaW9uKSB7XG4gICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgIHRocm93IGBJdCBpcyBub3QgcG9zc2libGUgdG8gc2V0IHRoZSB2ZXJzaW9uICR7b3B0aW9ucy52ZXJzaW9ufSB0byBkYXRhYmFzZSwgYmVjYXVzZSBpcyBsb3dlciB0aGVuIGN1cnJlbnQgdmVyc2lvbiwgRGIgY3VycmVudCB2ZXJzaW9uIGlzICR7Y3VyVmVyc2lvbn1gO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFNxbGl0ZUFjY2VzcyhkYiwgb3B0aW9ucyk7XG59Il19